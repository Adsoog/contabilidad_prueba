{% extends 'base.html' %}

{% block content %}
<h1 class="mb-4">Items de la Orden de Venta {{ ordenventa }}</h1>

<!-- Contenido previamente en el modal: Tabla de Precios ahora fuera -->
<div class="table-responsive">
    <!-- Clase table-responsive para hacer la tabla responsive -->
    <table class="table table-bordered">
        <!-- Clases de Bootstrap para estilizar la tabla -->
        <thead>
            <tr>
                <th>Descripción</th>
                <th>Precio Unitario</th>
                <th>Cantidad</th>
                <th>IGV (%)</th>
                <th>Detracción (%)</th>
                <th>Precio Total</th>
                <th>Proveedor</th>
                <th>Banco</th>
                <th>Número Bancario</th>
                <th>Cuotas</th>
                <th>Tipo de Pago</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="text" id="descripcion" /></td>
                <td><input type="number" id="precio" oninput="calcularPrecioTotal()" /></td>
                <td><input type="number" id="cantidad" oninput="calcularPrecioTotal()" /></td>
                <td><input type="number" id="igv" oninput="calcularPrecioTotal()" /></td>
                <td><input type="number" id="detraccion" oninput="calcularPrecioTotal()" /></td>
                <td id="precioTotal">0.00</td>
                <td><input type="text" id="proveedor" /></td>
                <td><input type="text" id="banco" /></td>
                <td><input type="text" id="numeroBancario" /></td>
                <td><input type="number" id="cuotas" /></td>
                <td>
                    <select id="tipoDePago">
                        <option value="soles">SOLES</option>
                        <option value="dolares">DOLARES</option>
                    </select>
                </td>
            </tr>
        </tbody>
    </table>
    <!-- Botón para añadir filas -->
    <button type="button" class="btn btn-success" onclick="agregarFila()">Añadir Fila</button>
</div>

<script>
    // Función para calcular el precio total incluyendo IGV y detracción
    function calcularPrecioTotal() {
        var cantidad = parseFloat(document.getElementById("cantidad").value);
        var precio = parseFloat(document.getElementById("precio").value);
        var igv = parseFloat(document.getElementById("igv").value);
        var detraccion = parseFloat(document.getElementById("detraccion").value);
        
        // Calcular subtotal
        var subtotal = cantidad * precio;
        
        // Calcular total con IGV
        var totalConIgv = subtotal * (1 + igv / 100);
        
        // Calcular detracción
        var totalConDetraccion = totalConIgv * (1 - detraccion / 100);

        // Mostrar precio total
        document.getElementById("precioTotal").innerHTML = totalConDetraccion.toFixed(2);
    }
    
    function agregarFila() {
        var tabla = document.querySelector(".table-responsive .table tbody");
        var nuevaFila = tabla.insertRow(-1); // Inserta una fila al final de la tabla

        // Definir el contenido de la nueva fila (ajustar según sea necesario)
        var celdaHTML = `
            <td><input type="text" /></td>
            <td><input type="number" oninput="calcularPrecioTotal()" /></td>
            <td><input type="number" oninput="calcularPrecioTotal()" /></td>
            <td><input type="number" oninput="calcularPrecioTotal()" /></td>
            <td><input type="number" oninput="calcularPrecioTotal()" /></td>
            <td>0.00</td>
            <td><input type="text" /></td>
            <td><input type="text" /></td>
            <td><input type="text" /></td>
            <td><input type="number" /></td>
            <td>
                <select>
                    <option value="soles">SOLES</option>
                    <option value="dolares">DOLARES</option>
                </select>
            </td>
        `;

        // Asignar el contenido a la nueva fila
        nuevaFila.innerHTML = celdaHTML;
    }



</script>

<!-- Contenedor para la tabla de items que será actualizada por HTMX -->
<div id="items-container">
    <!-- Aquí se incluiría el contenido de "fragmentos/items_orden_venta.html" si es necesario -->
    <!-- Ejemplo de tabla con items de orden de venta, ajustar según sea necesario -->
    <table class="table">
        <thead class="table-dark">
            <tr>
                <th>Seleccionar</th>
                <th>Número de Artículo</th>
                <th>Descripción del Artículo</th>
                <th>Cantidad</th>
                <th>Precio Bruto</th>
                <th>Total Bruto</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr class="{% if not item.enviado %}table-success{% endif %}">
                <td><input type="checkbox" name="selected_items" value="{{ item.id }}"></td>
                <td>{{ item.nro_articulo }}</td>
                <td>{{ item.desc_articulo }}</td>
                <td>{{ item.cantidad }}</td>
                <td>{{ item.precio_bruto | floatformat:2 }}</td>
                <td>{{ item.total_bruto | floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6">No hay items en esta orden de venta.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

