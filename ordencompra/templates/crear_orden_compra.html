<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Orden de Compra</title>
</head>
<body>

<h1>Crear Orden de Compra</h1>

<form method="post" action="{% url 'crear_orden_compra' %}">
    {% csrf_token %}

    <table>
        <tr>
            <th>Descripción</th>
            <th>Precio</th>
            <th>Cantidad</th>
            <th>IGV</th>
            <th>Detracción</th>
            <th>Precio Total</th>
            <th>Tipo de Pago</th>
            <th>Clase</th>
            <th>Banco</th>
            <th>Número Bancario</th>
            <th>Cuotas</th>
        </tr>
        <tr>
            <td>{{ form.descripcion }}</td>
            <td>{{ form.precio }}</td>
            <td>{{ form.cantidad }}</td>
            <td>{{ form.igv }}</td>
            <td>{{ form.detraccion }}</td>
            <td>{{ form.precio_total }}</td>
            <td>{{ form.tipo_pago }}</td>
            <td>{{ form.clase }}</td>
            <td>{{ form.banco }}</td>
            <td>{{ form.numero_bancario }}</td>
            <td>{{ form.cuotas }}</td>
        </tr>
    </table>

    <!-- Tabla de Precios para agregar filas dinámicamente -->
    <table border="1" id="tablaPrecios">
        <thead>
            <tr>
                <th>Descripción</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>IGV (%)</th>
                <th>Detracción (%)</th>
                <th>Precio Total</th>
                <th>Tipo de Pago</th>
                <th>Clase</th>
                <th>Banco</th>
                <th>Número Bancario</th>
                <th>Cuotas</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button type="button" onclick="agregarFila()">Agregar Fila</button>
    <button type="button" onclick="guardarDatos()">Guardar Datos</button>
    <button type="submit">Guardar Orden de Compra</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
    // Función para calcular el precio total automáticamente
    function actualizarPrecioTotal(fila) {
        var precio = parseFloat(fila.children[1].innerText);
        var cantidad = parseFloat(fila.children[2].innerText);
        var igv = parseFloat(fila.children[3].innerText);
        var detraction = parseFloat(fila.children[4].innerText);

        if (isNaN(precio) || isNaN(cantidad) || isNaN(igv) || isNaN(detraction)) {
            fila.children[5].innerText = '';
            return;
        }

        var precioTotal = (precio * cantidad) * (1 + igv / 100) * (1 - detraction / 100);
        fila.children[5].innerText = precioTotal.toFixed(2);
    }

    // Función para agregar una nueva fila a la tabla
    function agregarFila() {
        var tabla = document.getElementById('tablaPrecios');
        var nuevaFila = tabla.insertRow(-1);

        for (var i = 0; i < 11; i++) {
            var celda = nuevaFila.insertCell(i);
            if (i === 6) {
                var listaDesplegableTipoPago = document.createElement('select');
                listaDesplegableTipoPago.innerHTML = '<option value="Planillas">Planillas</option>' +
                                            '<option value="Proveedores">Proveedores</option>' +
                                            '<option value="Bancos y Tarjetas">Bancos y Tarjetas</option>' +
                                            '<option value="Sunat">Sunat</option>' +
                                            '<option value="Bien o Servicio">Bien o Servicio</option>';
                celda.appendChild(listaDesplegableTipoPago);
            } else if (i === 7) {
                var listaDesplegableClase = document.createElement('select');
                listaDesplegableClase.innerHTML = '<option value="Pepsi">Pepsi</option>' +
                                            '<option value="CocaCola">CocaCola</option>';
                listaDesplegableClase.addEventListener('change', function() {
                    if (this.value === 'Pepsi') {
                        nuevaFila.children[8].innerText = 'Banco Pepsi';
                        nuevaFila.children[9].innerText = '123456789';
                    } else if (this.value === 'CocaCola') {
                        nuevaFila.children[8].innerText = 'Banco CocaCola';
                        nuevaFila.children[9].innerText = '987654321';
                    }
                });
                celda.appendChild(listaDesplegableClase);
            } else if (i === 10) {
                celda.contentEditable = "true";
            } else {
                celda.contentEditable = "true";
            }
        }

        nuevaFila.addEventListener('input', function(e) {
            if (e.target.tagName.toLowerCase() === 'td' && e.target.contentEditable === 'true') {
                if (e.target === nuevaFila.children[10]) {
                    var cuotas = parseFloat(e.target.innerText);
                    if (isNaN(cuotas)) {
                        e.target.innerText = '';
                        return;
                    }
                }
                actualizarPrecioTotal(nuevaFila);
            }
        });
    }

    // Función para guardar los datos en el formulario principal
    function guardarDatos() {
        // Copia los datos de la última fila de la tabla de precios al formulario principal
        var filasTablaPrecios = document.getElementById('tablaPrecios').rows;
        var ultimaFila = filasTablaPrecios[filasTablaPrecios.length - 1];

        for (var i = 0; i < 11; i++) {
            document.forms[0][i].value = ultimaFila.cells[i].innerText;
        }

        // Puedes eliminar las filas adicionales de la tabla de precios si lo deseas
        // ...

        alert('Datos guardados en el formulario principal');
    }
</script>
</body>
</html>
